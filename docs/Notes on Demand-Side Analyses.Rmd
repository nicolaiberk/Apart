---
title: "Notes on Demand-Side Analyses"
author: "Mendoza P."
date: "01/10/2019"
output: html_document
---

```{r setup, include=FALSE}
# RMD standard setup
knitr::opts_chunk$set(echo = FALSE)

# loading pkgs:
usePackage <- function(p) {if (!is.element(p, installed.packages()[,1]))install.packages(p,dep = TRUE, repos = "http://cran.wu.ac.at"); library(p, character.only = TRUE)}
pkgs <- c('beepr', 'tidyverse', 'rio', 'tidylog', 'skimr'); for (i in pkgs){usePackage(i)}
# dataviz pkgs:
pkgviz <- c('hrbrthemes', 'gridExtra', 'grid', 'extrafont')
for (i in pkgviz){usePackage(i)} 
# #Fonts: pkg: extrafont
# font_import()  # to install fonts already existing in your fonts folder to R [CAUTION: can take ages]
# loadfonts(device = "win") # to unpack them in R
# windowsFonts() # to check which fonts are loaded

```


### Thoughts on the data basis (CSES)

__Very heterogeneous Datasources!__

Useful for analyses of association (if participation covariates are unlikely confounders for the relationship under study)
For calculation of AP at country-level weighting by vote-shares can bring about more representativity.

### Coverage of CSES waves 1-4

```{r data, include=F}
# Datasets are from Comparative Study of Election Surveys https://cses.org/data-download/ 
datadir <- "C:/Users/Philipp/ucloud/01 Studium/Daten/cses/"  # personalize your datadirectory
csint <- import(paste0(datadir,"/cses_imd_r/cses_imd.rdata"))

```

How many countries are there?
```{r firstexp, include=T, echo=T}
csint$IMD1006_NAM %>% n_distinct()
```

Which countries are in there?
```{r firstexp2, include=T, echo=T}
csint$IMD1006_NAM %>% unique
```

_Neat visualization pls!_

The following is a lollipop chart a nice tutorial for this and other nice plots can be retrived from the R-Gallery: https://www.r-graph-gallery.com/303-lollipop-plot-with-2-values.html

```{r dataviz, include=T, echo=F, warning=F, message=F, out.height=800, out.width=1000}
# at the moment this plot only covers up to 7 elections, just add a row to expand
meta <- group_by(csint, IMD1006_NAM) %>% 
  mutate(min2 = IMD1008_YEAR %>% unique %>% sort() %>% nth(2),
         min3 = IMD1008_YEAR %>% unique %>% sort() %>% nth(3),
         min4 = IMD1008_YEAR %>% unique %>% sort() %>% nth(4),
         min5 = IMD1008_YEAR %>% unique %>% sort() %>% nth(5),
         min6 = IMD1008_YEAR %>% unique %>% sort() %>% nth(6) 
  ) %>% 
  summarise(nobs=n_distinct(IMD1004),
            maxy=max(IMD1008_YEAR), 
            miny=min(IMD1008_YEAR),
            min2 = mean(min2,na.rm=T),
            min3 = mean(min3,na.rm=T),
            min4 = mean(min4,na.rm=T),
            min5 = mean(min5,na.rm=T),
            min6 = mean(min6,na.rm=T)
            )
for (i in paste0("min",2:6)){meta[i][meta[i]==meta$maxy] <- NA}
names(meta)[1] <- "c"

# Which coverage interval? 
meta1 <- meta %>% rowwise() %>% 
  mutate(mymean = mean(c(miny,maxy))) %>% 
  mutate(rangey = maxy-miny) %>% 
  arrange(-miny)       # sort by first year; alternatively by rangey, -mymean, nobs
meta1$x <- factor(meta1$c,meta1$c)

# Plot for first & last election covered
a <- ggplot(meta1) +
  geom_segment( aes(x=x, xend=x, y=miny, yend=maxy), color="darkgrey") +
  geom_point( aes(x=x, y=miny), color=rgb(0.2,0.7,0.1,0.9), size=3 ) +
  geom_point( aes(x=x, y=maxy), color=rgb(0.7,0.2,0.1,0.9), size=3 ) +
  geom_point( aes(x=x, y=min2), color="grey", size=2 ) +
  geom_point( aes(x=x, y=min3), color="grey", size=2 ) +
  geom_point( aes(x=x, y=min4), color="grey", size=2 ) +
  geom_point( aes(x=x, y=min5), color="grey", size=2 ) +
  geom_point( aes(x=x, y=min6), color="grey", size=2 ) +
  coord_flip() +
  theme_minimal(base_family="Garamond") +
  theme(legend.position = "none",
        plot.margin=unit(c(0.5,-0.5,0.5,0.5), "cm"),
        axis.text.y = element_text(size=6)
        ) +
  xlab("") +
  ylab("First and last year of coverage")

# Plot for number of elections covered
b <- meta1 %>% ggplot() + geom_col(aes(x=x,y=nobs)) + 
  coord_flip() + xlab("") + ylab("Number of Elections") +
  theme_minimal(base_family="Garamond") + theme(axis.text.y=element_blank(),
                          plot.margin=unit(c(0.5,0.5,0.5,-0.2), "cm"))

# Combination of the two plots
# png("CSES_coverage.png", width=200, height=170, res=300, units = "mm", family = "Garamond") #To save your graph
grid.arrange(grobs=list(a,b),
             layout_matrix=rbind(c(1,1,1,2),
                                 c(1,1,1,2)),
             top=textGrob("Coverage of CSES by Country",gp=gpar(fontfamily="Garamond"))) 
# dev.off()  #To save your graph

```



#### Ideas for further Analyses/Projects
- Lollipop chart on difference election & polling date (same would be possible to do for every survey)


### Code for DataViz above:
```{r dataviz_tut, include=T, echo=T, eval=F}
# at the moment this plot only covers up to 7 elections, just add a row to expand
meta <- group_by(csint, IMD1006_NAM) %>% 
  mutate(min2 = IMD1008_YEAR %>% unique %>% sort() %>% nth(2),
         min3 = IMD1008_YEAR %>% unique %>% sort() %>% nth(3),
         min4 = IMD1008_YEAR %>% unique %>% sort() %>% nth(4),
         min5 = IMD1008_YEAR %>% unique %>% sort() %>% nth(5),
         min6 = IMD1008_YEAR %>% unique %>% sort() %>% nth(6) 
  ) %>% 
  summarise(nobs=n_distinct(IMD1004),
            maxy=max(IMD1008_YEAR), 
            miny=min(IMD1008_YEAR),
            min2 = mean(min2,na.rm=T),
            min3 = mean(min3,na.rm=T),
            min4 = mean(min4,na.rm=T),
            min5 = mean(min5,na.rm=T),
            min6 = mean(min6,na.rm=T)
            )
for (i in paste0("min",2:6)){meta[i][meta[i]==meta$maxy] <- NA}
names(meta)[1] <- "c"

# Which coverage interval? 
meta1 <- meta %>% rowwise() %>% 
  mutate(mymean = mean(c(miny,maxy))) %>% 
  mutate(rangey = maxy-miny) %>% 
  arrange(-miny)       # sort by first year; alternatively by rangey, -mymean, nobs
meta1$x <- factor(meta1$c,meta1$c)

# Plot for first & last election covered
a <- ggplot(meta1) +
  geom_segment( aes(x=x, xend=x, y=miny, yend=maxy), color="darkgrey") +
  geom_point( aes(x=x, y=miny), color=rgb(0.2,0.7,0.1,0.9), size=3 ) +
  geom_point( aes(x=x, y=maxy), color=rgb(0.7,0.2,0.1,0.9), size=3 ) +
  geom_point( aes(x=x, y=min2), color="grey", size=2 ) +
  geom_point( aes(x=x, y=min3), color="grey", size=2 ) +
  geom_point( aes(x=x, y=min4), color="grey", size=2 ) +
  geom_point( aes(x=x, y=min5), color="grey", size=2 ) +
  geom_point( aes(x=x, y=min6), color="grey", size=2 ) +
  coord_flip()+
  theme_minimal(base_family="Garamond") +
  theme(legend.position = "none",
        plot.margin=unit(c(0.5,-0.5,0.5,0.5), "cm")) +
  xlab("") +
  ylab("First and last year of coverage")

# Plot for number of elections covered
b <- meta1 %>% ggplot() + geom_col(aes(x=x,y=nobs)) + 
  coord_flip() + xlab("") + ylab("Number of Elections") +
  theme_minimal(base_family="Garamond") + theme(axis.text.y=element_blank(),
                          plot.margin=unit(c(0.5,0.5,0.5,-0.2), "cm"))

# Combination of the two plots
# png("CSES_coverage.png", width=200, height=170, res=300, units = "mm", family = "Garamond") #To save your graph
grid.arrange(grobs=list(a,b), 
             layout_matrix=rbind(c(1,1,1,2),
                                 c(1,1,1,2)),
             top=textGrob("Coverage of CSES by Country",gp=gpar(fontfamily="Garamond"))) 
# dev.off()  #To save your graph

```



